#!/bin/sh

# è„šæœ¬æ‰§è¡Œå¤±è´¥æ—¶è„šæœ¬ç»ˆæ­¢æ‰§è¡Œ
set -o errexit
# é‡åˆ°æœªå£°æ˜å˜é‡æ—¶è„šæœ¬ç»ˆæ­¢æ‰§è¡Œ
set -o nounset
# æ‰§è¡Œç®¡é“å‘½ä»¤æ—¶ï¼Œåªè¦æœ‰ä¸€ä¸ªå­å‘½ä»¤å¤±è´¥ï¼Œåˆ™è„šæœ¬ç»ˆæ­¢æ‰§è¡Œ
set -o pipefail
# æ‰“å°æ‰§è¡Œè¿‡ç¨‹ï¼Œä¸»è¦ç”¨äºè°ƒè¯•
#set -o xtrace

#===========================================================================================
# TimeZone Configuration
#===========================================================================================
if [ -n "$TZ" ]; then
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
fi

#===========================================================================================
# Script
#===========================================================================================
case "$1" in
    time)
        echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” \033[35m$(date +"%Y-%m-%d %H:%M:%S")\033[0m â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â”ƒ Wait $2 seconds"
        echo "â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        for i in $(seq 1 $2)
        do
            echo "â”ƒ ğŸ’— Remaining $(($2 - $i)) seconds..."
            sleep 1
        done
        echo "â”ƒ âœ… Time's up!"
        echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        exit 0
    ;;
    tcp|udp)
        protocol=$(echo $1 | tr '[:lower:]' '[:upper:]')
        if [ "$1" == "UDP" ]; then
            protocol="UDP"
        else
            protocol="TCP"
        fi
        echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” \033[35m$(date +"%Y-%m-%d %H:%M:%S")\033[0m â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â”ƒ Wait for $protocol $2:$3"
        echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        while [ 1 ]; do

            # è¾“å‡ºå‘½ä»¤ä¿¡æ¯
            echo ""
            echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” \033[35m$(date +"%Y-%m-%d %H:%M:%S")\033[0m â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # æ‰§è¡Œå‘½ä»¤
            set +o errexit

            # æ²¡åŠæ³•æ•æ‰ nc è¾“å‡ºçš„æ—¥å¿—ï¼Œæœ‰ç‚¹å‘çˆ¹
            if [ "$protocol" == "TCP" ]; then
                echo "â”ƒ \$ nc -zv $2 $3"
                nc -zv $2 $3
            else
                echo "â”ƒ \$ nc -uzv $2 $3"
                nc -uzv $2 $3
            fi

            status=$?
            set -o errexit

            echo "â”ƒ"
            # æ£€æŸ¥è¿”å›çš„çŠ¶æ€ç 
            if [ "$status" == "0" ]; then
                echo "â”ƒ âœ… Socket connect succeeded"
                echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit 0
            else
                echo "â”ƒ âŒ Socket connect failed"
                echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                sleep 2
            fi
        done
        exit 0
    ;;
    lookup)
        echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” \033[35m$(date +"%Y-%m-%d %H:%M:%S")\033[0m â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â”ƒ Wait for lookup '$2'"
        echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        while [ 1 ]; do
            # æ‰§è¡Œå‘½ä»¤
            set +o errexit
            output=$(nslookup $2)
            status=$?
            set -o errexit

            # è¾“å‡ºå‘½ä»¤ä¿¡æ¯
            echo ""
            echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” \033[35m$(date +"%Y-%m-%d %H:%M:%S")\033[0m â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â”ƒ \$ nslookup $2"
            echo "$output" | awk -v prefix="â”ƒ " '{print prefix $0}'
            echo "â”ƒ"

            # æ£€æŸ¥è¿”å›çš„çŠ¶æ€ç 
            if [ "$status" == "0" ]; then
                echo "â”ƒ âœ… Service Found"
                echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit 0
            else
                echo "â”ƒ âŒ Service Not Found"
                echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                sleep 2
            fi
        done
        exit 0
    ;;
    get)
        echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” \033[35m$(date +"%Y-%m-%d %H:%M:%S")\033[0m â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â”ƒ Wait for 'GET $2'"
        echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        while [ 1 ]; do
            # å‘é€ curl è¯·æ±‚ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 5 ç§’
            set +o errexit
            response=$(curl -s -m 5 -o /dev/null -w "%{http_code}" "$2")
            set -o errexit

            # è¾“å‡ºå‘½ä»¤ä¿¡æ¯
            echo ""
            echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” \033[35m$(date +"%Y-%m-%d %H:%M:%S")\033[0m â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â”ƒ \$ curl -s -m 5 -o /dev/null -w %{http_code} $2"
            echo "â”ƒ"

            # æ£€æŸ¥è¿”å›çš„çŠ¶æ€ç 
            if [ "$response" == "200" ]; then
                echo "â”ƒ âœ… Response Status: 200"
                echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit 0
            elif [ "$response" == "000" ]; then
                echo "â”ƒ âŒ Response Timeout"
                echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                sleep 2
            elif [ "$response" == "7" ]; then
                echo "â”ƒ âŒ Server Not Reachable"
                echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                sleep 2
            else
                echo "â”ƒ âŒ Response Status: $response"
                echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                sleep 2
            fi
        done
    ;;
    cmd)
        shift
        echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” \033[35m$(date +"%Y-%m-%d %H:%M:%S")\033[0m â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â”ƒ Wait for command '$@'"
        echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        while [ 1 ]; do
            # æ‰§è¡Œå‘½ä»¤
            set +o errexit
            output=$($@)
            status=$?
            set -o errexit

            # è¾“å‡ºå‘½ä»¤ä¿¡æ¯
            echo ""
            echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” \033[35m$(date +"%Y-%m-%d %H:%M:%S")\033[0m â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â”ƒ \$ $@"
            echo "$output" | awk -v prefix="â”ƒ " '{print prefix $0}'
            echo "â”ƒ"

            # æ£€æŸ¥è¿”å›çš„çŠ¶æ€ç 
            if [ "$status" == "0" ]; then
                echo "â”ƒ âœ… Exit Status: 0"
                echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit 0
            else
                echo "â”ƒ âŒ Exit Status: $status"
                echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                sleep 2
            fi
        done
    ;;
    *)
        echo "Unsupported command '$1'"
        exit 1
esac